name: Build iOS App

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Pozwala na rÄ™czne uruchomienie z GitHub UI

jobs:
  build-ios:
    name: Build iOS IPA
    runs-on: macos-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm install --legacy-peer-deps

      - name: ðŸŽ Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: ðŸŽ¨ Generate default assets
        run: |
          # Create assets directory if it doesn't exist
          mkdir -p assets
          
          # Generate a simple icon using ImageMagick (available on macOS runners)
          # If ImageMagick is not available, create a placeholder
          if command -v convert &> /dev/null; then
            convert -size 1024x1024 xc:#00d4ff -gravity center -pointsize 200 -fill white -annotate +0+0 "ðŸ“±" assets/icon.png
            convert -size 1024x1024 xc:#0f0f23 -gravity center -pointsize 200 -fill "#00d4ff" -annotate +0+0 "ðŸ“±" assets/splash-icon.png
            convert -size 1024x1024 xc:#00d4ff -gravity center -pointsize 200 -fill white -annotate +0+0 "ðŸ“±" assets/adaptive-icon.png
            convert -size 16x16 xc:#00d4ff assets/favicon.png
          else
            # Fallback: download a simple placeholder or skip icons
            echo "ImageMagick not available, using expo defaults"
          fi

      - name: ðŸ“± Generate native iOS project
        run: npx expo prebuild --platform ios --clean

      - name: ðŸ’Ž Install CocoaPods dependencies
        run: |
          cd ios
          pod install
          cd ..

      - name: ðŸ”¨ Build iOS app
        run: |
          # Dynamically find the workspace and scheme name
          WORKSPACE=$(find ios -name "*.xcworkspace" -maxdepth 1 | head -n 1)
          SCHEME=$(basename "$WORKSPACE" .xcworkspace)
          
          echo "Building workspace: $WORKSPACE"
          echo "Using scheme: $SCHEME"
          
          xcodebuild -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath ${{ github.workspace }}/build/app.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: ðŸ“¦ Create IPA
        run: |
          # Find the app name dynamically
          APP_NAME=$(find build/app.xcarchive/Products/Applications -name "*.app" -maxdepth 1 | head -n 1)
          APP_BASENAME=$(basename "$APP_NAME")
          
          echo "Found app: $APP_BASENAME"
          
          mkdir -p build/Payload
          cp -r "$APP_NAME" build/Payload/
          cd build
          zip -r app.ipa Payload
          cd ..

      - name: ðŸ“¤ Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-unsigned
          path: build/app.ipa
          retention-days: 30

      - name: âœ… Build complete
        run: |
          echo "ðŸŽ‰ IPA zostaÅ‚ zbudowany!"
          echo "ðŸ“± Pobierz plik z zakÅ‚adki Actions â†’ Artifacts"
          echo "ðŸ”§ Zainstaluj przez Sideloadly na swoim iPhone"
